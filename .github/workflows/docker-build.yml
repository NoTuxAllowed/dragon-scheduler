name: Docker Build and Push

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        target: [dragonctl, k8s-kubeadm-token-server, scheduler]
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Log in to GitHub Container Registry
      run: docker login ghcr.io -u ${{ github.actor }} --password "${{ secrets.GITHUB_TOKEN }}"
    - name: Set up QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static

    - name: Build and Push ${{ matrix.target }}
      env:
        DOCKER_CLI_EXPERIMENTAL: enabled
      run: |
        # Convert repository name to lowercase
        REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_BASE=ghcr.io/$REPO/${{ matrix.target }}
        
        echo "Building for amd64..."
        docker build --platform linux/amd64 --target ${{ matrix.target }} -t ${IMAGE_BASE}:latest-amd64 .
        docker push ${IMAGE_BASE}:latest-amd64
        
        echo "Building for arm64..."
        docker build --platform linux/arm64 --target ${{ matrix.target }} -t ${IMAGE_BASE}:latest-arm64 .
        docker push ${IMAGE_BASE}:latest-arm64
        
        echo "Creating and pushing manifest..."
        docker manifest create ${IMAGE_BASE}:latest \
          ${IMAGE_BASE}:latest-amd64 \
          ${IMAGE_BASE}:latest-arm64
          
        docker manifest push ${IMAGE_BASE}:latest
